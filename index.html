<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Combustible y Mantenimiento</title>
  <style>
    :root{--primary:#0b5fff;--muted:#6b7280;--card:#ffffff;--bg:#f3f4f6}
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:var(--bg);color:#111}
    header{background:linear-gradient(90deg,var(--primary),#3ea0ff);padding:18px 24px;color:white;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    .menu{display:flex;gap:12px}
    .btn{background:white;color:var(--primary);border-radius:10px;padding:10px 14px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(11,95,255,0.12)}
    .btn.secondary{background:transparent;color:white;border:1px solid rgba(255,255,255,0.18)}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
    input[type="text"], input[type="date"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px}
    .qtys{display:flex;gap:8px}
    .qtys > div{flex:1}
    .two-copies{display:flex;gap:12px;margin-top:14px}
    .copy{flex:1;background:#fafafa;padding:12px;border-radius:8px;border:1px dashed #e2e8f0}
    .tot{font-weight:800;font-size:16px;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}
    .summary-table{width:100%;border-collapse:collapse;margin-top:8px}
    .summary-table th,.summary-table td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .footer{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap}
    .actions{display:flex;gap:8px}
    .right{display:flex;flex-direction:column;gap:8px}
    .hidden{display:none}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.two-copies{flex-direction:column}}
  </style>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Control de Combustible y Mantenimiento</h1>
    <div class="menu">
      <button class="btn" id="btn-combustible">COMBUSTIBLE</button>
      <button class="btn secondary" id="btn-mantenimiento">MANTENIMIENTO</button>
    </div>
  </header>

  <div class="container">
    <div id="page-inicio">
      <div class="card">
        <h2>Bienvenido</h2>
        <p class="small">Selecciona una de las opciones arriba para comenzar. Esta aplicación funciona completamente en tu navegador. Se guardan los registros en el "Excel virtual" almacenado en el navegador (localStorage). Puedes exportarlos a un archivo .xlsx cuando quieras.</p>
      </div>
    </div>

    <div id="page-combustible" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Registro - COMBUSTIBLE</h2>

          <label>Máquina</label>
          <select id="maquina">
            <option>RETRO</option>
            <option>NIVELADORA</option>
            <option>VOLQUETA</option>
            <option>VIBRO</option>
          </select>

          <label>Fecha</label>
          <input type="date" id="fecha" />

          <p class="small" style="margin-top:8px">Ingrese cantidades (si deja vacío o 0, se asumirá 0):</p>
          <div class="qtys">
            <div>
              <label>ACPM (litros) — precio unitario $20</label>
              <input type="number" id="acpm" min="0" step="0.1" placeholder="0" />
            </div>
            <div>
              <label>CORRIENTE (litros) — precio unitario $10</label>
              <input type="number" id="corriente" min="0" step="0.1" placeholder="0" />
            </div>
            <div>
              <label>UREA (litros) — precio unitario $5</label>
              <input type="number" id="urea" min="0" step="0.1" placeholder="0" />
            </div>
          </div>

          <div class="footer">
            <div class="actions">
              <button class="btn" id="btn-generar">Generar</button>
              <button class="btn" id="btn-exportar">Exportar todo (XLSX)</button>
              <button class="btn secondary" id="btn-limpiar">Limpiar registros</button>
            </div>
            <div class="right">
              <small class="small">Precios: ACPM $20 | CORRIENTE $10 | UREA $5</small>
              <small class="small">Los datos se guardan en tu navegador; para compartir la app sube este archivo a GitHub Pages o un hosting estático.</small>
            </div>
          </div>

          <div id="mensaje" style="margin-top:10px"></div>

          <div class="two-copies" id="recibos"></div>
        </div>

        <div class="card">
          <h3>Resumen y Consulta</h3>
          <button class="btn" id="btn-resumen">Generar resumen por máquina</button>
          <div id="resumen" style="margin-top:10px"></div>

          <h4 style="margin-top:16px">Registros recientes</h4>
          <div id="lista-registros" style="max-height:320px;overflow:auto;margin-top:8px"></div>
        </div>
      </div>
    </div>

    <div id="page-mantenimiento" class="hidden">
      <div class="card">
        <h2>MANTENIMIENTO</h2>
        <p class="small">Sección de mantenimiento: placeholder por ahora. Si quieres que la extienda con órdenes de trabajo, repuestos y costos, lo hago y lo integro con el mismo sistema de almacenamiento.</p>
      </div>
    </div>

  </div>

  <script>
    // Precios
    const PRECIOS = {ACPM:20, CORRIENTE:10, UREA:5};

    // DOM
    const pageInicio = document.getElementById('page-inicio');
    const pageComb = document.getElementById('page-combustible');
    const pageMant = document.getElementById('page-mantenimiento');
    const btnComb = document.getElementById('btn-combustible');
    const btnMant = document.getElementById('btn-mantenimiento');

    const maquinaEl = document.getElementById('maquina');
    const fechaEl = document.getElementById('fecha');
    const acpmEl = document.getElementById('acpm');
    const corrienteEl = document.getElementById('corriente');
    const ureaEl = document.getElementById('urea');
    const btnGenerar = document.getElementById('btn-generar');
    const recibosEl = document.getElementById('recibos');
    const mensajeEl = document.getElementById('mensaje');
    const listaRegistros = document.getElementById('lista-registros');
    const resumenEl = document.getElementById('resumen');
    const btnResumen = document.getElementById('btn-resumen');
    const btnExport = document.getElementById('btn-exportar');
    const btnLimpiar = document.getElementById('btn-limpiar');

    // Inicializar fecha con hoy
    fechaEl.valueAsDate = new Date();

    // Navegación simple
    btnComb.addEventListener('click', ()=>{showPage('combustible')});
    btnMant.addEventListener('click', ()=>{showPage('mantenimiento')});

    function showPage(p){
      pageInicio.classList.add('hidden');
      pageComb.classList.add('hidden');
      pageMant.classList.add('hidden');
      if(p==='combustible') pageComb.classList.remove('hidden');
      if(p==='mantenimiento') pageMant.classList.remove('hidden');
      if(p==='inicio') pageInicio.classList.remove('hidden');
    }

    // Storage key
    const STORAGE_KEY = 'combustible_registros_v1';

    function readStorage(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      try{ return JSON.parse(raw); }catch(e){return []}
    }
    function writeStorage(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function formatoMoneda(v){
      return '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function renderRecibos(record){
      recibosEl.innerHTML = '';
      ['COPIA 1','COPIA 2'].forEach((titulo)=>{
        const div = document.createElement('div'); div.className='copy';
        div.innerHTML = `<h4>${titulo}</h4>
          <div><strong>Recibo - ${record.maquina}</strong></div>
          <div class="small">Fecha: ${record.fecha}</div>
          <hr />
          <div>ACPM: ${record.acpm_qty} L — ${formatoMoneda(record.acpm_total)}</div>
          <div>CORRIENTE: ${record.corriente_qty} L — ${formatoMoneda(record.corriente_total)}</div>
          <div>UREA: ${record.urea_qty} L — ${formatoMoneda(record.urea_total)}</div>
          <div class="tot">TOTAL: ${formatoMoneda(record.total_precio)}</div>
          <div class="small" style="margin-top:8px">Código: ${record.timestamp}</div>
        `;
        recibosEl.appendChild(div);
      });
    }

    function añadirRegistro(record){
      const arr = readStorage();
      arr.push(record);
      writeStorage(arr);
    }

    function renderListaRegistros(){
      const arr = readStorage().slice().reverse();
      if(arr.length===0){ listaRegistros.innerHTML='<div class="small">No hay registros aún.</div>'; return; }
      listaRegistros.innerHTML = '';
      arr.slice(0,200).forEach(r=>{
        const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
        d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${r.maquina}</strong><div class='small'>${r.fecha}</div></div><div>${formatoMoneda(r.total_precio)}</div></div>`;
        listaRegistros.appendChild(d);
      });
    }

    btnGenerar.addEventListener('click', ()=>{
      const maquina = maquinaEl.value;
      const fecha = fechaEl.value || new Date().toISOString().slice(0,10);
      const acpm_qty = parseFloat(acpmEl.value) || 0;
      const corriente_qty = parseFloat(corrienteEl.value) || 0;
      const urea_qty = parseFloat(ureaEl.value) || 0;

      const acpm_total = acpm_qty * PRECIOS.ACPM;
      const corriente_total = corriente_qty * PRECIOS.CORRIENTE;
      const urea_total = urea_qty * PRECIOS.UREA;
      const total_precio = acpm_total + corriente_total + urea_total;

      const record = {
        timestamp: new Date().toISOString(),
        maquina, fecha,
        acpm_qty, corriente_qty, urea_qty,
        acpm_total, corriente_total, urea_total,
        total_precio
      };

      añadirRegistro(record);
      mensajeEl.innerHTML = `<div style="color:green;font-weight:700;margin-top:8px">Registro guardado ✔</div>`;
      renderRecibos(record);
      renderListaRegistros();
    });

    btnResumen.addEventListener('click', ()=>{
      const arr = readStorage();
      if(arr.length===0){ resumenEl.innerHTML = '<div class="small">No hay registros.</div>'; return; }
      // Agrupar
      const resumen = {};
      arr.forEach(r=>{
        if(!resumen[r.maquina]) resumen[r.maquina] = {acpm:0,corriente:0,urea:0,total:0};
        resumen[r.maquina].acpm += Number(r.acpm_qty) || 0;
        resumen[r.maquina].corriente += Number(r.corriente_qty) || 0;
        resumen[r.maquina].urea += Number(r.urea_qty) || 0;
        resumen[r.maquina].total += Number(r.total_precio) || 0;
      });

      let html = '<table class="summary-table"><thead><tr><th>Máquina</th><th>ACPM (L)</th><th>CORRIENTE (L)</th><th>UREA (L)</th><th>Valor (pesos)</th></tr></thead><tbody>';
      let totales = {acpm:0,corriente:0,urea:0,total:0};
      for(const m in resumen){
        const r = resumen[m];
        html += `<tr><td>${m}</td><td>${r.acpm.toFixed(2)}</td><td>${r.corriente.toFixed(2)}</td><td>${r.urea.toFixed(2)}</td><td>${formatoMoneda(r.total)}</td></tr>`;
        totales.acpm += r.acpm; totales.corriente += r.corriente; totales.urea += r.urea; totales.total += r.total;
      }
      html += `</tbody></table>
        <div style="margin-top:10px"><strong>Totales generales:</strong><div class="small">ACPM: ${totales.acpm.toFixed(2)} L — CORRIENTE: ${totales.corriente.toFixed(2)} L — UREA: ${totales.urea.toFixed(2)} L</div><div class="tot">Valor total: ${formatoMoneda(totales.total)}</div></div>`;

      resumenEl.innerHTML = html;
    });

    btnExport.addEventListener('click', ()=>{
      const arr = readStorage();
      if(arr.length===0){ alert('No hay registros para exportar.'); return; }
      // Convertir a sheet
      const ws = XLSX.utils.json_to_sheet(arr);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'registros');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout],{type:'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'registros_combustible.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    btnLimpiar.addEventListener('click', ()=>{
      if(confirm('¿Eliminar todos los registros almacenados en este navegador? Esta acción no se puede deshacer en este navegador.')){
        localStorage.removeItem(STORAGE_KEY);
        renderListaRegistros();
        resumenEl.innerHTML='';
        recibosEl.innerHTML='';
        mensajeEl.innerHTML = '<div style="color:#b91c1c">Registros eliminados.</div>';
      }
    });

    // Inicial render
    renderListaRegistros();
  </script>
</body>
</html>
